<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

      #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
      #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
      #input:focus { outline: none; }
      #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages > li { padding: 0.5rem 1rem; color: #1d1d1d; }
      #messages > li:nth-child(odd) { background: #efefef; }

      #cards { list-style-type: none; margin: 0; padding: 0; }
      #cards > li { padding: 0.5rem 1rem; color: #db332e; }
      #cards > li:nth-child(odd) { background: #efefef; color: #1d1d1d; }

      #players { list-style-type: none; margin: 0; padding: 0; }
      #players > li { padding: 0.5rem 1rem; color: #1d1d1d; }
      #players > li:nth-child(odd) { background: #efefef; }
    </style>
  </head>
  <body>
    <ul id="cards"></ul>
    <ul id="players"></ul>
    <ul id="messages"></ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      let bid = -1;

      let elem = document.getElementById('form');

      var messages = document.getElementById('messages');
      var form = document.getElementById('form');
      var input = document.getElementById('input');
      var title = document.getElementById('title');
      var gameBoardCards = document.getElementById('cards');
      var gameBoardPlayers = document.getElementById('players');
      elem.style.visibility = 'hidden';
    
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
          if (bid === -1) {
            socket.emit('bid', input.value);
            bid = input.value;
            elem.style.visibility = 'hidden';
          } else {
            input.value = input.value.toUpperCase();
            let suit = input.value.substring(0, 1);
            let val = input.value.substring(1);
            if (suit === 'S') {
              suit = 0;
            } else if (suit === 'H') {
              suit = 1;
            } else if (suit === 'C') {
              suit = 2;
            } else {
              suit = 3;
            }

            if (val === 'J') {
              val = 9;
            } else if (val === 'Q') {
              val = 10;
            } else if (val === 'K') {
              val = 11;
            } else if (val === 'A') {
              val = 12;
            } else {
              val = parseInt(val)-2;
            }

            let card = 13*suit+val;
            socket.emit('play card', card);
            elem.style.visibility = 'hidden';
          }
          input.value = '';
        }
      });

      socket.on('board', function(board) {
        console.log(board);
        board = JSON.parse(board);
        let cards = {
          "spades": [],
          "hearts": [],
          "clubs": [],
          "diamonds": []
        };

        for (let i=0; i<board.players.length; i++) {
          delete board.players[i].id;
          if (board.players[i].cards.length) {
            for (let j=0; j<board.players[i].cards.length; j++) {
              let suit = Math.floor(board.players[i].cards[j]/13);
              if (suit === 0) {
                cards.spades.push(prettyCard(board.players[i].cards[j]));
              } else if (suit === 1) {
                cards.hearts.push(prettyCard(board.players[i].cards[j]));
              } else if (suit === 2) {
                cards.clubs.push(prettyCard(board.players[i].cards[j]));
              } else {
                cards.diamonds.push(prettyCard(board.players[i].cards[j]));
              }
            }
            board.players[i].cards = cards;
          } else {
            delete board.players[i].cards;
          }
        }

        gameBoardCards.textContent = "";
        gameBoardPlayers.textContent = "";

        for (let i=0; i<4; i++) {
          var item = document.createElement('li');
          if (i === 0) {
            item.textContent = `♠️: ${cards.spades}`;
          } else if (i === 1) {
            item.textContent = `♥️: ${cards.hearts}`;
          } else if (i === 2) {
            item.textContent = `♣️: ${cards.clubs}`;
          } else {
            item.textContent = `♦️: ${cards.diamonds}`;
          }

          gameBoardCards.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        }

        for (let i=0; i<board.players.length; i++) {
          var item = document.createElement('li');
          item.textContent = `${board.players[i].name}: Bid: ${board.players[i].bid}, Tricks: ${board.players[i].tricks}, Score: ${board.players[i].score}`;
          gameBoardPlayers.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        }
      });

      socket.on('status', function(msg) {
        console.log(msg);
        if (msg === 'new round') {
          bid = -1;
          messages.textContent = "";
        }

        if (msg.msg === 'insufficient bid. bid again') {
          bid = -1;
        }

        if (msg.canType) {
          elem.style.visibility = 'visible';
        }
      });

      socket.on('play card', function(msg) {
        var item = document.createElement('li');
        if (msg.player) {
          item.textContent = `${msg.player} played ${prettyCard(msg.card)}`;
        } else {
          item.textContent = msg;
        }
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      });

      function prettyCard(card) {
        let suit = Math.floor(card/13);
        let val = card%13+2;
        let ret = "";

        if (val === 11) {
          val = "J";
        } else if (val === 12) {
          val = "Q";
        } else if (val === 13) {
          val = "K";
        } else if (val === 14) {
          val = "A";
        }

        if (suit === 0) {
          ret = `${val}♠️`;
        } else if (suit === 1) {
          ret = `${val}♥️`;
        } else if (suit === 2) {
          ret = `${val}♣️`;
        } else {
          ret = `${val}♦️`;
        }

        return ret;
      }
    </script>
  </body>
</html>